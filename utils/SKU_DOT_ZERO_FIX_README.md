# Исправление проблемы с .0 в SKU коллекций

## Проблема

В базе данных некоторые SKU коллекций содержат `.0` в конце (например, `642657364143.0`), хотя должны быть текстовыми идентификаторами без десятичной части. Это приводит к:

- Некорректным именам папок с изображениями
- Несоответствию между SKU в разных таблицах
- Проблемам с поиском и идентификацией коллекций

## Причина

Вероятно, SKU импортировались как числовые значения и затем конвертировались в текст, что привело к добавлению `.0` для целых чисел.

## Решение

Созданы два скрипта для диагностики и исправления проблемы:

### 1. check_sku_status.py - Диагностика

**Назначение**: Проверка текущего состояния SKU в базе данных и файловой системе.

**Функции**:
- Показывает все SKU с `.0` в таблицах `product_collection` и `product_collection_images`
- Проверяет папки с `.0` в файловой системе
- Выявляет дублирующиеся папки (с `.0` и без)
- Проверяет согласованность между БД и файловой системой

**Использование**:
```bash
cd x:\DATA_STORAGE\Furnithai\utils
python check_sku_status.py
```

### 2. fix_sku_dot_zero.py - Исправление

**Назначение**: Автоматическое исправление SKU с `.0` в базе данных и переименование папок.

**Функции**:
- Удаляет `.0` из SKU в таблице `product_collection`
- Обновляет `collection_sku` в таблице `product_collection_images`
- Исправляет пути в поле `url_local`
- Переименовывает соответствующие папки с изображениями
- Ведет подробный лог операций

**Использование**:
```bash
cd x:\DATA_STORAGE\Furnithai\utils
python fix_sku_dot_zero.py
```

## Пошаговая инструкция

### Шаг 1: Диагностика (обязательно)

```bash
python check_sku_status.py
```

Это покажет:
- Сколько SKU нужно исправить
- Какие папки будут переименованы
- Есть ли конфликты (дублирующиеся папки)

### Шаг 2: Резервное копирование (рекомендуется)

```sql
-- Создать резервную копию таблиц
CREATE TABLE product_collection_backup AS SELECT * FROM product_collection;
CREATE TABLE product_collection_images_backup AS SELECT * FROM product_collection_images;
```

### Шаг 3: Исправление

```bash
python fix_sku_dot_zero.py
```

Скрипт:
1. Покажет план исправления
2. Запросит подтверждение
3. Выполнит исправления с логированием
4. Создаст лог в `pictures/fix_sku_log.txt`

### Шаг 4: Проверка результата

```bash
python check_sku_status.py
```

Должно показать:
- 0 SKU с `.0` в базе данных
- 0 папок с `.0` в файловой системе
- Согласованность между БД и ФС

## Безопасность

### Меры предосторожности:
1. **Резервное копирование**: Обязательно создайте бэкап БД
2. **Тестирование**: Сначала запустите на тестовой среде
3. **Поэтапное выполнение**: Скрипт обрабатывает по одному SKU с коммитом
4. **Логирование**: Все операции записываются в лог
5. **Откат при ошибках**: При ошибке изменения откатываются

### Что делает скрипт:
- ✅ Обновляет `product_collection.product_collection_sku`
- ✅ Обновляет `product_collection_images.collection_sku`
- ✅ Исправляет пути в `product_collection_images.url_local`
- ✅ Переименовывает папки с изображениями
- ✅ Ведет подробный лог операций

### Что НЕ делает скрипт:
- ❌ Не удаляет данные
- ❌ Не изменяет содержимое файлов
- ❌ Не затрагивает другие таблицы

## Примеры исправлений

| До исправления | После исправления |
|----------------|-------------------|
| `642657364143.0` | `642657364143` |
| `891270836601.0` | `891270836601` |
| `524171512611.0` | `524171512611` |

## Логи

Все операции записываются в `pictures/fix_sku_log.txt`:

```
=== Начало исправления SKU с .0 ===
Найдено 9 SKU с .0 в конце

План исправления:
  642657364143.0 -> 642657364143
  891270836601.0 -> 891270836601
  ...

--- Обработка 642657364143.0 ---
[БД] 642657364143.0 -> 642657364143: product_collection=1, images=8, urls=8
[ПАПКА] Переименовано: 642657364143.0 -> 642657364143
[УСПЕХ] 642657364143.0 исправлен

=== Завершено: 9/9 SKU исправлено ===
```

## Восстановление (если нужно)

Если что-то пошло не так:

```sql
-- Восстановить из резервной копии
DROP TABLE product_collection;
DROP TABLE product_collection_images;
ALTER TABLE product_collection_backup RENAME TO product_collection;
ALTER TABLE product_collection_images_backup RENAME TO product_collection_images;
```

## Файлы

- `check_sku_status.py` - скрипт диагностики
- `fix_sku_dot_zero.py` - скрипт исправления
- `SKU_DOT_ZERO_FIX_README.md` - данная документация
- `pictures/fix_sku_log.txt` - лог операций (создается при исправлении)

## Рекомендации

1. **Проверить источник данных**: Выяснить, почему SKU импортируются с `.0`
2. **Валидация при импорте**: Добавить проверки для предотвращения повторения проблемы
3. **Мониторинг**: Регулярно проверять качество данных SKU
4. **Документация**: Обновить процедуры импорта данных